<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rust Editor Pro: Layers & Assets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME & LAYOUT --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f0f0f;
            color: #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }

        h1 {
            font-family: 'Black Ops One', cursive;
            color: #ce422b;
            margin: 10px 0;
            letter-spacing: 2px;
            font-size: 24px;
        }

        /* Main Workspace: 3 Columns (Assets | Canvas | Layers) */
        .workspace {
            display: flex;
            width: 98%;
            height: calc(100vh - 60px);
            gap: 15px;
        }

        /* --- COLUMN 1: ASSETS (LEFT) --- */
        .panel-left {
            width: 280px;
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            background: #252525;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            text-transform: uppercase;
            font-size: 0.8rem;
            color: #fff;
            text-align: center;
        }
        .asset-grid {
            padding: 10px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .asset-btn {
            aspect-ratio: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .asset-btn:hover { background: #444; border-color: #ce422b; }
        .asset-btn svg { width: 70%; height: 70%; fill: #aaa; pointer-events: none; }

        /* --- COLUMN 2: CANVAS (CENTER) --- */
        .panel-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
            padding-top: 40px;
            background: #111;
            border: 1px solid #222;
        }

        .canvas-container-outer {
            border: 2px solid #ce422b;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        /* Toolbar below canvas */
        .toolbar {
            display: flex;
            gap: 15px;
            background: #222;
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid #333;
        }
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #444;
            padding-right: 15px;
        }
        .tool-group:last-child { border: none; }
        
        input[type="color"] {
            background: none; border: none; width: 30px; height: 30px; cursor: pointer;
        }
        
        button.action-btn {
            background: #444; border: none; color: white;
            padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
        }
        button.action-btn:hover { background: #666; }
        button.save-btn { background: #ce422b; }
        button.save-btn:hover { background: #e05e46; }

        /* --- COLUMN 3: LAYERS (RIGHT) --- */
        .panel-right {
            width: 250px;
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .layers-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #222;
            border-bottom: 1px solid #333;
            cursor: pointer;
            user-select: none;
            font-size: 0.85rem;
        }
        .layer-item:hover { background: #2a2a2a; }
        .layer-item.active { background: #3d3d3d; border-left: 3px solid #ce422b; }
        
        .layer-name { flex: 1; margin-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .layer-icon { width: 20px; height: 20px; background: #444; border-radius: 3px; }
        .layer-actions { display: flex; gap: 5px; opacity: 0.5; }
        .layer-item:hover .layer-actions { opacity: 1; }
        
        .mini-btn {
            background: none; border: 1px solid #555; color: #aaa;
            width: 20px; height: 20px; font-size: 10px; cursor: pointer; border-radius: 2px;
            display: flex; align-items: center; justify-content: center;
        }
        .mini-btn:hover { background: #fff; color: #000; }
        .mini-btn.del:hover { background: #a00; color: #fff; border-color: #a00; }

    </style>
</head>
<body>

    <h1>KillaDome Emblem Editor</h1>

    <div class="workspace">
        
        <div class="panel-left">
            <div class="panel-header">Decal Library</div>
            <div class="asset-grid" id="assetGrid">
                </div>
        </div>

        <div class="panel-center">
            
            <div class="canvas-container-outer">
                <canvas id="c" width="1133" height="207"></canvas>
            </div>

            <div class="toolbar">
                <div class="tool-group">
                    <label style="font-size:0.7rem; text-transform:uppercase;">Color</label>
                    <input type="color" id="colorInput" onchange="updateColor(this.value)" value="#ffffff">
                </div>
                <div class="tool-group">
                    <label style="font-size:0.7rem; text-transform:uppercase;">BG</label>
                    <input type="color" id="bgColorInput" onchange="updateBgColor(this.value)" value="#000000">
                </div>
                <div class="tool-group">
                    <button class="action-btn" onclick="bringForward()">Up ▲</button>
                    <button class="action-btn" onclick="sendBackward()">Down ▼</button>
                </div>
                <button class="action-btn save-btn" onclick="exportImage()">SAVE CARD</button>
            </div>
        </div>

        <div class="panel-right">
            <div class="panel-header">Layers</div>
            <div class="layers-list" id="layersList">
                <div style="padding:20px; text-align:center; color:#555; font-size:0.8rem;">No layers</div>
            </div>
        </div>

    </div>

    <script>
        // ===========================================
        // 1. EXTENSIVE ASSET LIBRARY
        // ===========================================
        const svgAssets = [
            // BASICS
            { name: "Square", path: "M 0 0 h 512 v 512 h -512 Z" },
            { name: "Circle", path: "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512z" },
            { name: "Triangle", path: "M256 32L20 464h472L256 32z" },
            { name: "Ring", path: "M256 80c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176S353.2 80 256 80z m0 304c-70.7 0-128-57.3-128-128s57.3-128 128-128 128 57.3 128 128-57.3 128-128 128z" },
            
            // MILITARY / RANKS
            { name: "Chevron", path: "M256 298.3l174.2-162.7c4.6-4.3 11.5-4.9 16.7-1.5l25.1 16.5c6.3 4.1 7.2 12.6 1.9 17.8L265.4 366.8c-5.1 5.1-13.6 5.1-18.7 0L19.1 168.4c-5.3-5.3-4.4-13.7 1.9-17.8l25.1-16.5c5.2-3.4 12.1-2.8 16.7 1.5L256 298.3z" },
            { name: "Star", path: "M256 32L326.6 175.3 484.6 198.2 370.3 309.7 397.3 467.2 256 392.8 114.7 467.2 141.7 309.7 27.4 198.2 185.4 175.3 256 32z" },
            { name: "Shield", path: "M256,0C114.6,0,0,114.6,0,256s114.6,256,256,256s256-114.6,256-256S397.4,0,256,0z M384,256H256v128C185.3,384,128,326.7,128,256H256V128C326.7,128,384,185.3,384,256z" },
            { name: "Medal", path: "M224 480h64c17.7 0 32-14.3 32-32V360.8l56.8 51.6c6.2 5.6 15.6 5.8 22 .5l30.5-26.7c6.7-5.9 7-16.1 1.2-22.3L320 256l110.5-108c5.8-6.2 5.5-16.4-1.2-22.3l-30.5-26.7c-6.4-5.3-15.8-5.1-22 .5L320 151.2V64c0-17.7-14.3-32-32-32h-64c-17.7 0-32 14.3-32 32v87.2l-56.8-51.6c-6.2-5.6-15.6-5.8-22-.5l-30.5 26.7c-6.7 5.9-7 16.1-1.2 22.3L192 256 81.5 363.9c-5.8 6.2-5.5 16.4 1.2 22.3l30.5 26.7c6.4 5.3 15.8 5.1 22-.5l56.8-51.6V448c0 17.7 14.3 32 32 32z" },

            // SYMBOLS
            { name: "Skull", path: "M256 0C114.6 0 0 87.1 0 194.7c0 48.7 17.5 93.3 46.8 128.5 2.1 2.5 3.3 5.7 3.3 9v74.5c0 14.8 8.8 28.1 22.4 33.9l36.3 15.6c13.7-43.2 54.3-74.8 102.1-74.8s88.4 31.6 102.1 74.8l36.3-15.6c13.6-5.8 22.4-19.1 22.4-33.9v-74.5c0-3.3 1.2-6.5 3.3-9C494.5 288 512 243.4 512 194.7 512 87.1 397.4 0 256 0z m-85.3 229.3c-23.6 0-42.7-19.1-42.7-42.7s19.1-42.7 42.7-42.7 42.7 19.1 42.7 42.7-19.1 42.7-42.7 42.7z m170.6 0c-23.6 0-42.7-19.1-42.7-42.7s19.1-42.7 42.7-42.7 42.7 19.1 42.7 42.7-19.1 42.7-42.7 42.7z" },
            { name: "Biohazard", path: "M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512z M368 256a112 112 0 1 1-224 0 112 112 0 1 1 224 0z" },
            { name: "Target", path: "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z" },
            { name: "Grenade", path: "M368 144h-49.4l39.1-78.2c4-8 2.4-17.7-3.9-23.9C343.6 31.6 329 24.7 313.7 21.9c-16.9-3.1-34.2-.9-50.3 6.4L146.3 80c-17.5 7.9-23.3 29.6-11.7 44.4l37.1 47.7c-18.7 21.5-32.5 47.5-39.7 76H96c-17.7 0-32 14.3-32 32s14.3 32 32 32h32.1c2 25.9 10 50 23.1 71.3L123 411.7c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l28.3-28.3c21.3 13.1 45.4 21.1 71.3 23.1V484c0 17.7 14.3 32 32 32s32-14.3 32-32v-32.1c25.9-2 50-10 71.3-23.1l28.3 28.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-28.3-28.3c13.1-21.3 21.1-45.4 23.1-71.3H484c17.7 0 32-14.3 32-32s-14.3-32-32-32h-35.9c-7.2-28.5-21-54.5-39.7-76l37.1-47.7c11.6-14.9 5.8-36.6-11.7-44.4L368 144z" },
            { name: "Flame", path: "M191.4 30.9c23.6 15.9 44 37.7 59.1 63.8 2.6 4.5 9.1 3.9 10.8-1 9.6-27.9 28.6-52.2 54.4-69.3 5-3.3 11.5 .6 11 6.5-.5 5.5 .3 11.1 2.3 16.2 12.9 32.6 30.5 63.5 52.4 91.8 30 38.8 49.3 84.8 54.1 133.5 6.3 64.6-14.9 129.5-59.1 176.7C324.2 496.3 252.6 512 181 487.8c-55.8-18.9-102.9-60.6-130.6-113.3C21.7 319.8 20 256.7 45.6 199.3c17.6-39.4 46.1-73.4 81.3-98.7 5.1-3.7 7.9-10 7-16.2-2.3-15.6-1.5-31.5 2.1-46.7 1.4-6.1 9.4-8.5 14.1-3.6 13.6 14.2 27.4 28.5 41.3 42.6z" },
            { name: "Wings", path: "M116.9 286.1c-5.8-22.5-13-44.3-21.8-65.5-17-41-38.6-78-62.8-111.7C14.6 82.6 0 103.6 0 126.2c0 44 18.3 83.8 47.7 112.5 15.9 15.5 34.1 28.3 53.7 38.2 5 2.6 10.4 3.1 15.5 9.2zM431.5 238.7c19.6-9.9 37.8-22.7 53.7-38.2C514.1 171.8 532.4 132 532.4 88c0-22.6-14.6-43.6-32.3-17.2-24.2 33.7-45.8 70.7-62.8 111.7-8.8 21.2-16 43-21.8 65.5 5.1-6.1 10.5-6.6 15.5-9.2zM266.2 297.5c37.2-2.1 72.7-13 104.7-31 34.9-19.7 65.8-46.5 91.4-79.8C411 225 343.4 256.6 266.2 256.6c-77.2 0-144.8-31.6-196.1-89.9 25.6 33.3 56.5 60.1 91.4 79.8 32 18 67.5 28.9 104.7 31z" },
            { name: "Claw", path: "M256 0c-40.4 0-78.6 12.8-110.1 34.6-16.6 11.5-35.3 20.3-54.2 20.3C41 54.9 0 95.9 0 146.6c0 48.7 38.1 88.6 87.2 91.5 5 2.9 8.2 8.4 8.2 14.3v16.1c0 23.7 17.5 43.6 40.5 47.1 23.8 3.7 45.6-12.7 49.3-36.5 2.1-13.2-6.5-25.2-19.1-27.2l-21.8-3.4c-8.9-1.4-15.3-9-15.3-18.1V214c0-17.7-14.3-32-32-32-17.7 0-32 14.3-32 32v16c0 30.6-21.8 56.4-51.5 62 25.4 47.9 75.7 80 133 80 83.1 0 150.5-67.4 150.5-150.5S339.1 71 256 71c-14.8 0-29.1 2.2-42.7 6.2 11.2 18.5 17.7 40.3 17.7 63.3v16.1c0 5.8 3.2 11.3 8.2 14.3 49.1-2.9 87.2-42.8 87.2-91.5 0-50.7-41-91.7-91.7-91.7-18.9 0-37.6-8.8-54.2-20.3C292.6 12.8 254.4 0 256 0z" },
            
            // WEAPONS / TOOLS
            { name: "Knife", path: "M472.9 33.6c-7.9-7.4-20.2-7.1-27.8 .7l-156 160.8c-6.1 6.3-4.6 16.7 2.8 20.9l26.4 15.1c4.2 2.4 9.4 1.7 12.9-1.9L473.6 61.4c7.6-7.8 7.3-20.4-.7-27.8zm-298.6 305c-6.1 6.3-4.6 16.7 2.8 20.9l26.4 15.1c4.2 2.4 9.4 1.7 12.9-1.9l142.4-149.2c7.6-7.8 7.3-20.4-.7-27.8-7.9-7.4-20.2-7.1-27.8 .7L174.3 338.6z M57.4 200.6L12.3 252.8c-12.7 14.7-12.7 36.6 0 51.3L153.2 467c14.7 17 38.6 17 53.3 0l45.1-52.2c12.7-14.7 12.7-36.6 0-51.3L110.7 200.6c-14.7-17-38.6-17-53.3 0z" },
            { name: "Crosshair", path: "M256,48C141.3,48,48,141.3,48,256s93.3,208,208,208s208-93.3,208-208S370.7,48,256,48z M256,432c-97,0-176-79-176-176S159,80,256,80s176,79,176,176S353,432,256,432z M240,128h32v96h96v32h-96v96h-32v-96h-96v-32h96V128z" },
            { name: "Splatter", path: "M206.8 29.8c12.2 2.3 12.2 20 0 22.3-39.7 7.5-66.7 44.5-61.9 84.8 .7 6 5.3 10.9 11.2 12 59.9 10.7 99.4 67.5 88.7 128.4-9.3 53-55.3 92.2-109.1 92.7-2.6 0-5.1-1.1-6.9-3-1.8-1.9-2.7-4.5-2.5-7.1l9.1-137.9c1.6-24.9 22.1-44.5 47-45.1 24.9-.6 45.4 19.3 45.8 44.2 .1 5.3-4.1 9.8-9.4 9.9l-11.8 .1c-22.3 .3-40.3 18.5-40 40.8 .3 22.3 18.5 40.3 40.8 40l11.8-.1c35.6-.4 64.2-29.3 64.2-64.9 0-21.4-10.7-40.6-26.9-52.1-16.7-11.9-26.7-31.5-26.7-52.1 0-41.6 24.6-77.8 60-94.8 11.1-5.3 7-21.8-5.3-21.4-56.7 1.8-106.6-26.7-133.5-75.3-2.6-4.7-9.4-4.8-12.1-.2-27.1 48-77.5 77.2-134.3 77.8-12.4 .1-16.5 16.6-6.1 22.3 35.4 19.4 58.7 57.3 56.7 100.8-.6 13.9-4.8 26.6-11.6 37.6-6.7 10.9-20.9 14.5-31.8 7.8-10.9-6.7-14.5-20.9-7.8-31.8 4.2-6.8 6.7-14.7 7.1-23.2 .9-20.8-10.3-39.1-27.8-49.8-17.5-10.7-39.6-9.6-55.8 2.8-5.3 4.1-3.6 12.4 2.8 14.1 40.6 10.9 66.7 48.6 63.7 90.7-2.2 29.8-19.4 55.3-44.2 68.8-11.2 6.1-25 2.2-31.1-9-6.1-11.2-2.2-25 9-31.1 11.4-6.2 19.3-17.9 20.3-31.6 1.4-19.4-10.6-36.7-29.3-41.7-6.2-1.7-12.4 2.8-12.4 9.3 0 29.6 15.6 55.4 39.4 69.1 23.8 13.7 52.8 12.1 74.9-3.9 22.1-16 35.6-41.2 35.6-69.1 0-47.5-32.9-88.4-78.2-97.1-14.2-2.7-16-22-3.1-27.1 41.5-16.3 75.3-49.8 92.5-91.3 2.6-6.3 11.8-5.7 13.6 .9z" },

        ];

        // ===========================================
        // 2. SETUP FABRIC CANVAS
        // ===========================================
        const canvas = new fabric.Canvas('c', {
            preserveObjectStacking: true, // Needed for layers to work intuitively
            backgroundColor: '#000000'
        });

        // ===========================================
        // 3. UI GENERATION (ASSETS)
        // ===========================================
        const assetGrid = document.getElementById('assetGrid');
        
        svgAssets.forEach(asset => {
            const btn = document.createElement('div');
            btn.className = 'asset-btn';
            btn.title = asset.name;
            btn.innerHTML = `<svg viewBox="0 0 512 512"><path d="${asset.path}"></path></svg>`;
            
            btn.onclick = () => addShape(asset.path, asset.name);
            assetGrid.appendChild(btn);
        });

        // ===========================================
        // 4. CORE FUNCTIONS
        // ===========================================
        function addShape(pathData, name) {
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="${pathData}" fill="#ffffff"></path></svg>`;
            
            fabric.loadSVGFromString(svgString, (objects, options) => {
                const loadedObject = fabric.util.groupSVGElements(objects, options);
                
                loadedObject.set({
                    left: canvas.width / 2,
                    top: canvas.height / 2,
                    originX: 'center',
                    originY: 'center',
                    scaleX: 0.2, 
                    scaleY: 0.2,
                    fill: document.getElementById('colorInput').value,
                    // Custom property to store the name for the Layer List
                    layerName: name || "Shape" 
                });

                canvas.add(loadedObject);
                canvas.setActiveObject(loadedObject);
                canvas.renderAll();
                updateLayersPanel();
            });
        }

        // ===========================================
        // 5. LAYERS PANEL LOGIC (The "Window")
        // ===========================================
        const layersListEl = document.getElementById('layersList');

        function updateLayersPanel() {
            layersListEl.innerHTML = '';
            
            // Get all objects
            const objects = canvas.getObjects();
            
            // Reverse loop (because Fabric stores 0 as bottom, but we want Top at Top of list)
            // We use standard loop backwards
            if(objects.length === 0) {
                layersListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#555; font-size:0.8rem;">No layers</div>';
                return;
            }

            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                const isActive = (canvas.getActiveObject() === obj);
                
                // Create Item Container
                const item = document.createElement('div');
                item.className = `layer-item ${isActive ? 'active' : ''}`;
                
                // Clicking item selects the object on canvas
                item.onclick = (e) => {
                    // Prevent triggering if we clicked a button
                    if(e.target.tagName === 'BUTTON') return;
                    
                    canvas.setActiveObject(obj);
                    canvas.renderAll();
                };

                // Layer Icon
                const icon = document.createElement('div');
                icon.className = 'layer-icon';
                icon.style.backgroundColor = obj.fill || '#fff';
                
                // Layer Name
                const name = document.createElement('span');
                name.className = 'layer-name';
                name.innerText = `${obj.layerName} (${i})`;

                // Actions (Up/Down/Del)
                const actions = document.createElement('div');
                actions.className = 'layer-actions';

                // Delete Btn
                const btnDel = document.createElement('button');
                btnDel.className = 'mini-btn del';
                btnDel.innerText = 'X';
                btnDel.onclick = () => { canvas.remove(obj); updateLayersPanel(); };

                actions.appendChild(btnDel);

                // Assemble
                item.appendChild(icon);
                item.appendChild(name);
                item.appendChild(actions);
                
                layersListEl.appendChild(item);
            }
        }

        // ===========================================
        // 6. SYNCHRONIZATION
        // ===========================================

        // When selection changes on canvas, update the list highlighting
        canvas.on('selection:created', () => { updateLayersPanel(); syncColorTool(); });
        canvas.on('selection:updated', () => { updateLayersPanel(); syncColorTool(); });
        canvas.on('selection:cleared', () => { updateLayersPanel(); });
        
        // When objects are modified, re-render list (in case color changed for icon)
        canvas.on('object:modified', updateLayersPanel);

        function syncColorTool() {
            const active = canvas.getActiveObject();
            if(active && typeof active.fill === 'string') {
                document.getElementById('colorInput').value = active.fill;
            }
        }

        // ===========================================
        // 7. TOOLBAR FUNCTIONS
        // ===========================================
        function updateColor(val) {
            const active = canvas.getActiveObject();
            if(active) { active.set('fill', val); canvas.renderAll(); updateLayersPanel(); }
        }

        function updateBgColor(val) {
            canvas.backgroundColor = val;
            canvas.renderAll();
        }

        function bringForward() {
            const active = canvas.getActiveObject();
            if(active) { canvas.bringForward(active); updateLayersPanel(); }
        }

        function sendBackward() {
            const active = canvas.getActiveObject();
            if(active) { canvas.sendBackwards(active); updateLayersPanel(); }
        }

        function exportImage() {
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            const data = canvas.toDataURL({ format: 'png', quality: 1, multiplier: 1 });
            console.log(data);
            alert("Calling Card generated! Check console for Base64 data.");
        }
        
        // Initial Render
        updateLayersPanel();

    </script>
</body>
</html>